<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Display a globe on a webpage</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>

    <style>
        #layer-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            font: 14px Arial;
            z-index: 2;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        #legend-container {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 250px; /* adjust if you want wider */
    background: white;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    padding: 10px;
    overflow-y: auto; /* scroll if too many */
    max-height: 80vh; /* don't overflow screen */
    z-index: 3;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    font-size: 12px;
}

.legend {
    position: static; /* <-- change this from absolute to static */
    margin-bottom: 10px; /* add some breathing room between legends */
}

        .legend h4 {
            margin: 0 0 10px;
        }

        .legend div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }
    </style>
        <div id="container">
            <div id="layer-controls">
                <label><input type="checkbox" class="layer-toggle" value="parcels" checked> Parcels</label> 
                <label><input type="checkbox" class="layer-toggle" value="Lot-Sizes-of-Residential-Parcels"> Lot size</label><br>
                <label><input type="checkbox" class="layer-toggle" value="Too-Little-Frontage"> Insufficient frontage</label><br>
                <label><input type="checkbox" class="layer-toggle" value="Residential-Parcels-Smaller-than-Minimum-Lot-Size"> Insufficient lot size</label>   
                <label><input type="checkbox" class="layer-toggle" value="Overlay"> Overlays</label>        
                <label><input type="checkbox" class="layer-toggle" value="Zones"> Existing zoning</label>
    
            </div>
        </div>
    <div id="map"></div>
    <div id="legend-container">
        <div id="frontageLegend" class="legend" style="display: block;">
            <h4>Parcels</h4>
        </div>
        <div id="lotsizeLegend" class="legend" style="display: none;">
            <h4>Parcels</h4>
        </div>
        <div id="toosmallLegend" class="legend" style="display: none;">
            <h4>Parcels</h4>
        </div>
        <div id="overlayLegend" class="legend" style="display: none;">
            <h4>Parcels</h4>
        </div>
        <div id="existzoneLegend" class="legend" style="display: none;">
            <h4>Parcels</h4>
        </div>
    </div>



    <script>
        const lotSizePalette = [ //blue ramp
            '#E2FDFF',
            '#D1EAFF',
            '#BFD7FF',
            '#9BB1FF',
            '#8A9EFF',
            '#788BFF',
            '#5465FF',
            '#333FAC',
            '#1C2790',
            '#0D1667'
        ]

        const zones = ['BA', 'BB', 'BC', 'C', 'CR', 'HR1', 'HR2', 'I', 'LC', 'RA1', 'RA2', 'RA3', 'RA4', 'RB', 'RC', 'RD']
       
        const zoneColors = [
            "#ffb3b3", // BA
            "#f26b6b", // BB
            "#a82940", // BC
            "#f7d8d8", // C
            "#bdd66b", // CR
            "#0057e7", // HR1
            "#734ac3", // HR2
            "#b3b3b3", // I
            "#b7a4ff", // LC
            "#fff9dc", // RA1
            "#fff099", // RA2
            "#f4dd63", // RA3
            "#f5b72d", // RA4
            "#f18c1b", // RB
            "#c87a12", // RC
            "#a55a00"  // RD
        ];

        const zonesAndColors = zones.flatMap((zone, i) => [zone, zoneColors[i]]);

        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FyYWJyZW50IiwiYSI6ImNtMHpsb2Q4NTAwemoybHExbnB6eHVvZ2kifQ.nH0hUSv3IGzX6MkYB_cSmA';
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/light-v11',
            zoom: 14,
            center: [-71.236618, 42.378266],
            projection: 'globe'
        });

const legendEntries = {
    'Too-Little-Frontage': [
        { color: '#5d0e27', label: 'Frontage narrower than required by zone' }
    ],
    'Residential-Parcels-Smaller-than-Minimum-Lot-Size': [
        { color: '#bb1d4f', label: 'Lot smaller than required by zone' }
    ],
    'Lot-Sizes-of-Residential-Parcels': lotSizePalette.map((color, i) => ({
        color: color,
        label: `Bin ${i + 1}` // you could replace "Bin" with real sqft ranges if you want
    })),
    'Zones': zones.map((zone, i) => ({
        color: zoneColors[i],
        label: zone
    })),
    'Overlay': [
        { color: 'black', label: 'ROD' },
        { color: '#0040fe', label: 'LCRAP' },
        { color: '#21abe6', label: 'LCRA' },
        { color: '#9971ff', label: 'MCMOD' },
        { color: '#006663', label: 'MBTAW' }
    ]
};

        map.on('load', () => {
            // Set the default atmosphere style
            map.setFog({});

            map.addSource('mapillary', {
                'type': 'vector',
                'tiles': [
                    'https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=MLY|4142433049200173|72206abe5035850d6743b23a49c41333'
                ],
                'minzoom': 8,
                'maxzoom': 14
            })


            map.addSource('frontage', {
                type: 'geojson',
                data: 'frontages.geojson'
            });

            map.addSource('resipar', {
                type: 'geojson',
                data: 'resiparcels.geojson'
            });

            map.addSource('existing', {
                type: 'geojson',
                data: 'zoningexist2.geojson'
            });

            map.addSource('overlays', {
                type: 'geojson',
                data: 'overlays.geojson'
            });            

            map.addLayer({
                id: 'Residential-Parcels-Smaller-than-Minimum-Lot-Size',
                type: 'fill',
                source: 'resipar',
                paint: {
                    'fill-outline-color': 'white',
                    'fill-color': [
                        'match',
                        ['get', 'LotTooSmal'],
                        1, '#BB1D4F',
                        '#E5E4E2' // default fallback color
                    ],
                    'fill-opacity': 1,
                }
            });

            map.addLayer({
                id: 'Lot-Sizes-of-Residential-Parcels',
                type: 'fill',
                source: 'resipar',
                paint: {
                    'fill-outline-color': 'white',
                    'fill-color': [
                        "case", ["==", ["get", "SQFT"], null], 'white',
                        ["interpolate",
                            ["linear"],
                            ["get", "SQFT"],
                            0,
                            lotSizePalette[0],
                            4000,
                            lotSizePalette[1],
                            5000,
                            lotSizePalette[2],
                            6000,
                            lotSizePalette[3],
                            7000,
                            lotSizePalette[4],
                            8000,
                            lotSizePalette[5],
                            9000,
                            lotSizePalette[6],
                            10000,
                            lotSizePalette[7],
                            15000,
                            lotSizePalette[8],
                            20000,
                            lotSizePalette[9]
                        ]],
                    'fill-opacity': .9,
                }
            });

            map.addLayer({
                id: 'Zones',
                type: 'fill',
                source: 'existing',
                paint: {
                    'fill-color': ['match', ['string', ['get', 'NAME']], ...zonesAndColors, '#AAAAAA'],
                    'fill-opacity': 1,
                }
            });

            //this has to be last
            map.addLayer({
                id: 'parcels',
                type: 'fill',
                source: 'existing',
                paint: {
                    'fill-outline-color': 'black',
                    'fill-color': 'transparent',
                    'fill-opacity': 1,
                }
            });

            map.addLayer({
                id: 'Too-Little-Frontage',
                type: 'line',
                source: 'frontage',
                paint: {
                    'line-width': 3,
                    'line-color': [
                        'match',
                        ['get', 'TooLilFrnt'],
                        1, '#5d0e27',
                        
                        'rgba(14,7,27,0)' // default fallback color
                    ],
                }
            });

            map.addLayer({
                id: 'Overlay',
                type: 'line',
                source: 'overlays',
                paint: {
                    'line-width': 4,
                    'line-color': [
                        'match',
                        ['get', 'NAME'],
                        'ROD', 'black',
                        'LCRAP', '#0040fe',
                        'LCRA', '#21abe6',
                        'MCMOD', '#9971ff',
                        'MBTAW', '#006663',
                        'transparent' // default fallback color
                    ],
                }
            });


            map.setLayoutProperty('Too-Little-Frontage', 'visibility', 'none');
            map.setLayoutProperty('Residential-Parcels-Smaller-than-Minimum-Lot-Size', 'visibility', 'none');
            map.setLayoutProperty('Lot-Sizes-of-Residential-Parcels', 'visibility', 'none');
            map.setLayoutProperty('Zones', 'visibility', 'none');
            map.setLayoutProperty('Overlay', 'visibility', 'none');


            const checkboxes = document.querySelectorAll('.layer-toggle');

const legends = {
    'Too-Little-Frontage': 'frontageLegend',
    'Residential-Parcels-Smaller-than-Minimum-Lot-Size': 'toosmallLegend',
    'Lot-Sizes-of-Residential-Parcels': 'lotsizeLegend',
    'Zones': 'existzoneLegend',
    'Overlay': 'overlayLegend'
};

checkboxes.forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
        const layerId = checkbox.value;
        const visibility = checkbox.checked ? 'visible' : 'none';
        if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, 'visibility', visibility);
        }

        // Update all legends
        Object.keys(legends).forEach(layer => {
            const legendId = legends[layer];
            const legendElement = document.getElementById(legendId);
            const matchingCheckbox = Array.from(checkboxes).find(cb => cb.value === layer);

            if (matchingCheckbox && matchingCheckbox.checked) {
                legendElement.style.display = 'block';
                
                // Build the content dynamically
                if (legendEntries[layer]) {
                    legendElement.innerHTML = `
                        <h4>${layer.replace(/-/g, ' ')}</h4>
                        ${legendEntries[layer].map(entry => `
                            <div>
                                <span style="background:${entry.color};"></span>${entry.label}
                            </div>
                        `).join('')}
                    `;
                }
            } else {
                legendElement.style.display = 'none';
            }
        });
    });
});


        });


    </script>

</body>

</html>